<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Web Audio, by eridem</title>
</head>
<body>
  <h1>Oscillator</h1>
  <canvas class="visualizer";id="myCanvas";width="640" height="100"></canvas>
</body>
<body>
<h1>Web Audio, by ERiDeM</h1>
<p>Example 1: Loading from XMLHttpRequest</p>
<p>Panic documentation: <a href="https://webaudio.github.io/web-audio-api/#the-audiobuffersourcenode-interface">https://webaudio.github.io/web-audio-api/#the-audiobuffersourcenode-interface</a></p>
<canvas class="visualizer";id="myCanvas";width="640" height="100">
<script>
// Create the Audio Context
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();
var analyser = context.createAnalyser();
var WIDTH = 300;
var HEIGHT = 300;



var soundUrl = "zebre.wav";

// Create request to load the song from address
var request = new XMLHttpRequest();
request.open("GET", soundUrl, true);
request.responseType = "arraybuffer";

// Play the sound inside of Chrome

function playSound() {
  analyser.connect(context.destination);

  if (!soundBuffer) return;

  // Create AudioBufferSourceNode and attach buffer
  var source = context.createBufferSource();
  source.buffer = soundBuffer;

  // Connect it to the output
  source.connect(context.destination);

  // Play the source
  source.start(0);
  source.connect(analyser);

}

request.onload = function () {
    console.log("Sound loaded.");

    context.decodeAudioData(
        request.response,
        function (buffer) {
            window.soundBuffer = buffer;
            if (typeof window.playSound === 'function') window.playSound();
        }
    );
};


request.send();


window.requestAnimationFrame = (function(){
return window.requestAnimationFrame  ||
  window.webkitRequestAnimationFrame ||
  window.mozRequestAnimationFrame    ||
  window.oRequestAnimationFrame      ||
  window.msRequestAnimationFrame     ||
  function(callback){
  window.setTimeout(callback, 1000 / 60);
};
})();


var canvas = document.querySelector('.visualizer');
var drawContext = canvas.getContext("2d");

var freqDomain = new Uint8Array(analyser.frequencyBinCount);
analyser.getByteFrequencyData(freqDomain);
for (var i = 0; i < analyser.frequencyBinCount; i++) {
  var value = freqDomain[i];
  var percent = value / 256;
  var height = HEIGHT * percent;
  var offset = HEIGHT - height - 1;
  var barWidth = WIDTH/analyser.frequencyBinCount;
  var hue = i/analyser.frequencyBinCount * 360;
  drawContext.fillStyle = 'hsl(' + hue + ', 100%, 50%)';
  drawContext.fillRect(i * barWidth, offset, barWidth, height);
}

var timeDomain = new Uint8Array(analyser.frequencyBinCount);
analyser.getByteTimeDomainData(freqDomain);
for (var i = 0; i < analyser.frequencyBinCount; i++) {
  var value = timeDomain[i];
  var percent = value / 256;
  var height = HEIGHT * percent;
  var offset = HEIGHT - height - 1;
  var barWidth = WIDTH/analyser.frequencyBinCount;
  drawContext.fillStyle = 'black';
  drawContext.fillRect(i * barWidth, offset, 1, 1);
}


</script>
</canvas>
</body>
</html>
